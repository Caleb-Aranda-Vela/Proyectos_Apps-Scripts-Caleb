<!-- modificarLinea.html -->
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Formulario: Modificar Línea</title>
    <?!= HtmlService.createHtmlOutputFromFile('FormStyles').getContent(); ?>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .error-message { color: #dc3545; font-size: 0.875em; margin-top: 0.25em; display: none; }
        .disabled-field { background-color: #e9ecef !important; color: #6c757d !important; cursor: not-allowed; }
        .readonly-field { background-color: #f7fafc; border: 1px solid #e2e8f0; color: #2d3748; cursor: not-allowed; }
        .readonly-field:focus { box-shadow: none; border-color: #e2e8f0; }
        .form-actions-inline { display: flex; gap: 16px; justify-content: center; }
        .form-actions-inline .btn { width: auto; flex-grow: 1; }
        .search-inline { display: flex; align-items: flex-end; gap: 10px; }
        .search-inline div { flex-grow: 1; }
        .info-container {display: flex;align-items: center;gap: 8px;}
        .info-icon {display: inline-block;width: 18px;height: 18px;border-radius: 50%;background-color: #6c757d;color: white;text-align: center;font-size: 12px;font-weight: bold;line-height: 18px;cursor: pointer;position: relative;        }
        .info-icon .tooltiptext {visibility: hidden;width: 220px;background-color: #333;color: #fff;text-align: center;border-radius: 6px;padding: 8px;position: absolute;z-index: 1;bottom: 125%;left: 50%;margin-left: -110px;opacity: 0;transition: opacity 0.3s;}
        .info-icon:hover .tooltiptext {visibility: visible;opacity: 1;}
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h2 class="section-title">Modificación de Línea Celular</h2>
            
            <fieldset id="searchSection">
                <legend>Buscar Línea a Modificar</legend>
                <div class="form-grid" style="grid-template-columns: 1fr;">
                    <div>
                        <label for="searchTelefono">Número de Teléfono (10 dígitos)</label>
                        <input type="tel" id="searchTelefono" name="searchTelefono" maxlength="10" required>
                        <p id="searchTelefonoError" class="error-message"></p>
                    </div>
                </div>
                <div class="form-actions-inline" style="margin-top: 20px;">
                    <button type="button" class="btn btn-primary" id="searchBtn">Buscar Línea</button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">Limpiar</button>
                    <button type="button" class="btn btn-tertiary" id="redirectBtn">Volver al Menú</button>
                </div>
                <div id="searchLoading" class="loading" style="display: none;"><div class="spinner"></div><p>Buscando línea...</p></div>
            </fieldset>

            <form id="modificacionForm" style="display: none;">
                
                <fieldset>
                    <legend>Datos de Línea Celular</legend>
                    <div class="form-grid">
                        <div><label>Región</label><input type="text" id="region" class="readonly-field" readonly></div>
                        <div><label>Cuenta Padre</label><input type="text" id="cuenta_padre" class="readonly-field" readonly></div>
                        <div><label>Cuenta</label><input type="text" id="cuenta" class="readonly-field" readonly></div>
                        <div><label>Teléfono</label><input type="text" id="telefono" class="readonly-field" readonly></div>
                        <div><label>Clave Plan</label><input type="text" id="clave_plan" class="readonly-field" readonly></div>
                        <div><label>Nombre Plan</label><input type="text" id="nombre_plan" class="readonly-field" readonly></div>
                        <div><label>Minutos</label><input type="text" id="minutos" class="readonly-field" readonly></div>
                        <div><label>Mensajes (SMS)</label><input type="text" id="mensajes" class="readonly-field" readonly></div>
                        <div><label>Monto Renta</label><input type="text" id="monto_renta" class="readonly-field" readonly></div>
                        <div><label>Duración Plan</label><input type="text" id="duracion_plan" class="readonly-field" readonly></div>
                        <div><label>Fecha Inicio</label><input type="text" id="fecha_inicio" class="readonly-field" readonly></div>
                        <div><label>Fecha Término</label><input type="text" id="fecha_termino" class="readonly-field" readonly></div>
                        <div><label>SIM</label><input type="text" id="sim" class="readonly-field" readonly></div>
                        <div><label>Datos (GB)</label><input type="text" id="datos" class="readonly-field" readonly></div>
                        
                        <div><label for="tipo">Tipo de Servicio</label><select id="tipo" name="tipo" required></select></div>
                        <div><label for="responsable">Responsable</label><select id="responsable" name="responsable" required></select></div>
                        <div><label for="idsucursal">Sucursal</label><select id="idsucursal" name="idsucursal" required></select></div>
                        <div><label for="extension">Extensión</label><input type="text" id="extension" name="extension" maxlength="4"></div>
                        <div class="full-width"><label for="notas">Notas</label><textarea id="notas" name="notas" rows="3" maxlength="125"></textarea></div>
                    </div>
                </fieldset>

                <fieldset id="equipoVinculadoSection" style="display:none;">
                    <legend>Equipo Celular Vinculado</legend>
                    <div id="equipoVinculadoContent" class="form-grid">
                        <input type="hidden" id="vinculadoTipoEquipo">

                        <div><label>IMEI</label><input type="text" id="vinculadoImei" class="readonly-field" readonly></div>
                        <div><label>Costo Equipo</label><input type="text" id="vinculadoCosto" class="readonly-field" readonly></div>
                        <div><label>Fecha Compra</label><input type="text" id="vinculadoFechaCompra" class="readonly-field" readonly></div>
                        <div><label>Estado</label><input type="text" id="vinculadoEstado" class="readonly-field" readonly></div>
                        <div><label>Marca</label><input type="text" id="vinculadoMarca" class="readonly-field" readonly></div>
                        <div><label>Modelo</label><input type="text" id="vinculadoModelo" class="readonly-field" readonly></div>
                        <div class="full-width"><label>Observaciones</label><textarea id="vinculadoObservaciones" class="readonly-field" readonly rows="2"></textarea></div>
                        
                        <div class="full-width" id="nuevoEstadoEquipoVinculadoContainer" style="display: none; margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                            <label for="nuevoEstadoEquipoVinculado">Selecciona el nuevo estado del equipo actual vinculado</label>
                            <select id="nuevoEstadoEquipoVinculado" name="nuevoEstadoEquipoVinculado">
                                <option value="">Selecciona un estado...</option>
                                <option value="Stock">Stock</option>
                                <option value="Robado">Robado</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Reasignar Equipo Usado</legend>
                    <div class="search-inline">
                         <div>
                            <label for="searchEquipoImei">Buscar IMEI de equipo usado a vincular (Opcional)</label>
                            <input type="text" id="searchEquipoImei" name="searchEquipoImei" maxlength="16" placeholder="Ingresa IMEI y presiona Buscar...">
                         </div>
                         <button type="button" class="btn btn-secondary" id="searchEquipoBtn">Buscar</button>
                    </div>
                    <div id="equipoEncontradoContent" style="display: none; margin-top: 1rem;">
                        <hr style="margin: 20px 0; border-top: 1px solid #e2e8f0;">
                        <div class="form-grid">
                           <input type="hidden" id="nuevoEquipoId">
                           <input type="hidden" id="nuevoEquipoImei">
                           <div><label>Costo Equipo</label><input type="text" id="encontradoCosto" class="readonly-field" readonly></div>
                           <div><label>Fecha de Compra</label><input type="text" id="encontradoFechaCompra" class="readonly-field" readonly></div>
                           <div><label>Fecha de Recolección</label><input type="text" id="encontradoFechaRecoleccion" class="readonly-field" readonly></div>
                           <div><label>Estado</label><input type="text" id="encontradoEstado" class="readonly-field" readonly></div>
                           <div><label>Marca</label><input type="text" id="encontradoMarca" class="readonly-field" readonly></div>
                           <div><label>Modelo</label><input type="text" id="encontradoModelo" class="readonly-field" readonly></div>
                           <div><label>RAM</label><input type="text" id="encontradoRam" class="readonly-field" readonly></div>
                           <div><label>ROM</label><input type="text" id="encontradoRom" class="readonly-field" readonly></div>
                           <div><label>Sucursal</label><input type="text" id="encontradoSucursal" class="readonly-field" readonly></div>
                           <div><label>Responsable Actual</label><input type="text" id="encontradoResponsable" class="readonly-field" readonly></div>
                           <div class="full-width"><label for="nuevaFechaReasignacion">Nueva Fecha de Reasignación</label><input type="date" id="nuevaFechaReasignacion" name="nuevaFechaReasignacion" required></div>
                           <div class="full-width"><label for="nuevasObservaciones">Nuevas Observaciones (Opcional)</label><textarea id="nuevasObservaciones" name="nuevasObservaciones" rows="2" maxlength="125"></textarea></div>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Guardar Modificaciones</button>
                </div>
                <div id="submitLoading" class="loading" style="display: none;"><div class="spinner"></div><p>Guardando cambios...</p></div>
            </form>
        </div>
    </div>
    <div id="messageBox" class="message-box"></div>

    <script>
    (function() {
        // --- 1. REFERENCIAS A ELEMENTOS DEL DOM ---
        const searchSection = document.getElementById('searchSection');
        const searchTelefonoInput = document.getElementById('searchTelefono');
        const searchBtn = document.getElementById('searchBtn');
        const clearBtn = document.getElementById('clearBtn');
        const redirectBtn = document.getElementById('redirectBtn');
        const searchLoading = document.getElementById('searchLoading');
        const searchTelefonoError = document.getElementById('searchTelefonoError');
        const modificacionForm = document.getElementById('modificacionForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitLoading = document.getElementById('submitLoading');
        const tipoSelect = document.getElementById('tipo');
        const responsableSelect = document.getElementById('responsable');
        const sucursalSelect = document.getElementById('idsucursal');
        const extensionInput = document.getElementById('extension');
        const notasTextarea = document.getElementById('notas');
        const equipoVinculadoSection = document.getElementById('equipoVinculadoSection');
        const vinculadoImei = document.getElementById('vinculadoImei');
        const vinculadoCosto = document.getElementById('vinculadoCosto');
        const vinculadoFechaCompra = document.getElementById('vinculadoFechaCompra');
        const vinculadoEstado = document.getElementById('vinculadoEstado');
        const vinculadoMarca = document.getElementById('vinculadoMarca');
        const vinculadoModelo = document.getElementById('vinculadoModelo');
        const vinculadoObservaciones = document.getElementById('vinculadoObservaciones');
        const vinculadoTipoEquipoInput = document.getElementById('vinculadoTipoEquipo');
        const nuevoEstadoEquipoVinculadoContainer = document.getElementById('nuevoEstadoEquipoVinculadoContainer');
        const nuevoEstadoEquipoVinculadoSelect = document.getElementById('nuevoEstadoEquipoVinculado');
        const searchEquipoImeiInput = document.getElementById('searchEquipoImei');
        const searchEquipoBtn = document.getElementById('searchEquipoBtn');
        const equipoEncontradoContent = document.getElementById('equipoEncontradoContent');
        const nuevaFechaReasignacionInput = document.getElementById('nuevaFechaReasignacion');
        const nuevasObservacionesTextarea = document.getElementById('nuevasObservaciones');
        const messageBox = document.getElementById('messageBox');
        let originalData = {};

        // --- 2. FUNCIONES DE UTILIDAD ---
        function showMessageBox(message, type = 'success', duration = 4000) { /* ...código... */ }
        function setFormEnabled(formEl, enabled, loadingEl) { /* ...código... */ }
        function populateSelect(selectEl, data, placeholder) { /* ...código... */ }
        function allowOnlyNumbers(inputEl) { inputEl.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); }); }

        // --- 3. LÓGICA PRINCIPAL DEL FORMULARIO ---
        function initForm() {
            if (typeof google === 'undefined') { setTimeout(initForm, 100); return; }
            loadDropdowns();
            setupEventListeners();
            resetAllForms();
        }

        function setupEventListeners() {
            searchBtn.addEventListener('click', handleSearchLinea);
            clearBtn.addEventListener('click', resetAllForms);
            redirectBtn.addEventListener('click', handleRedirect);
            modificacionForm.addEventListener('submit', handleFormSubmit);
            searchEquipoBtn.addEventListener('click', handleSearchEquipo);
            allowOnlyNumbers(searchTelefonoInput);
            allowOnlyNumbers(extensionInput);
            allowOnlyNumbers(searchEquipoImeiInput);
        }

        function loadDropdowns() {
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(tipoSelect, res.data, 'Selecciona Tipo'); }).getDropdownOptions('Listas2', 'F2:F');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(responsableSelect, res.data, 'Selecciona Responsable'); }).getDropdownOptions('BD', 'A2:A');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(sucursalSelect, res.data, 'Selecciona Sucursal'); }).getDropdownOptions('Listados', 'F2:F');
        }

        function handleSearchLinea() {
            const telefono = searchTelefonoInput.value.trim();
            if (!/^\d{10}$/.test(telefono)) {
                searchTelefonoError.textContent = 'Debe ser un número de 10 dígitos.';
                searchTelefonoError.style.display = 'block';
                return;
            }
            searchTelefonoError.style.display = 'none';
            setFormEnabled(searchSection, false, searchLoading);
            google.script.run.withSuccessHandler(onSearchLineaSuccess).withFailureHandler(onSearchFailure).buscarLineaPorTelefono(telefono);
        }

        function onSearchLineaSuccess(response) {
            setFormEnabled(searchSection, true, searchLoading);
            if (response.success) {
                originalData = response.data;
                const { linea, equipoVinculado } = response.data;
                
                Object.keys(linea).forEach(key => {
                    const element = document.getElementById(key.toLowerCase());
                    if (element) { element.value = linea[key] || ''; }
                });
                
                if (equipoVinculado && equipoVinculado.IMEI) {
                    // ***** LÍNEA AÑADIDA *****
                    document.getElementById('vinculadoTipoEquipo').value = equipoVinculado.TipoEquipo || '';
                    document.getElementById('vinculadoImei').value = equipoVinculado.IMEI || '';
                    document.getElementById('vinculadoCosto').value = equipoVinculado.Costo_Equipo ? '$' + parseFloat(equipoVinculado.Costo_Equipo).toLocaleString('en-US') : '';
                    document.getElementById('vinculadoFechaCompra').value = equipoVinculado.Fecha_Compra || '';
                    document.getElementById('vinculadoEstado').value = equipoVinculado.Estado || '';
                    document.getElementById('vinculadoMarca').value = equipoVinculado.Marca || '';
                    document.getElementById('vinculadoModelo').value = equipoVinculado.Modelo || '';
                    document.getElementById('vinculadoObservaciones').value = equipoVinculado.Observaciones || '';
                    equipoVinculadoSection.style.display = 'block';
                } else {
                    equipoVinculadoSection.style.display = 'none';
                }

                modificacionForm.style.display = 'block';
                setFormEnabled(modificacionForm, true);
            } else {
                onSearchFailure({ message: response.message });
            }
        }

        function onSearchFailure(error) {
            setFormEnabled(searchSection, true, searchLoading);
            showMessageBox('Error en la búsqueda: ' + error.message, 'error');
        }

        function handleSearchEquipo() {
            const imei = searchEquipoImeiInput.value.trim();
            if (!/^\d{15,16}$/.test(imei)) {
                showMessageBox('El IMEI para buscar equipo debe ser de 15 o 16 dígitos.', 'error');
                return;
            }
            showMessageBox('Buscando equipo...', 'success', 2000);
            google.script.run.withSuccessHandler(onSearchEquipoSuccess).withFailureHandler(err => showMessageBox('Error: ' + err.message, 'error')).buscarEquipoPorIMEI(imei);
        }

        function onSearchEquipoSuccess(response) {
            if (response.success && response.data) {
                const equipo = response.data;
                document.getElementById('nuevoEquipoId').value = equipo.ID_Equipo;
                document.getElementById('nuevoEquipoImei').value = searchEquipoImeiInput.value.trim();

                // CORRECCIÓN: Se usan los nombres de propiedad EXACTOS que devuelve la función buscarEquipoPorIMEI
                document.getElementById('encontradoCosto').value = equipo.Costo_Equipo ? '$' + parseFloat(equipo.Costo_Equipo).toLocaleString('en-US') : '';
                document.getElementById('encontradoFechaCompra').value = equipo.Fecha_Compra || '';
                document.getElementById('encontradoFechaRecoleccion').value = equipo.Fecha_Recoleccion || '';
                document.getElementById('encontradoEstado').value = equipo.Estado || '';
                document.getElementById('encontradoMarca').value = equipo.Marca || '';
                document.getElementById('encontradoModelo').value = equipo.Modelo || '';
                document.getElementById('encontradoRam').value = equipo.RAM || ''; // Asegúrate que buscarEquipoPorIMEI devuelva RAM/ROM
                document.getElementById('encontradoRom').value = equipo.ROM || ''; // Asegúrate que buscarEquipoPorIMEI devuelva RAM/ROM
                document.getElementById('encontradoSucursal').value = equipo.IDSUCURSAL_Name || '';
                document.getElementById('encontradoResponsable').value = equipo.Responsable || '';

                equipoEncontradoContent.style.display = 'grid';

                if (document.getElementById('vinculadoTipoEquipo').value === 'Nuevo') {
                    document.getElementById('nuevoEstadoEquipoVinculadoContainer').style.display = 'block';
                    document.getElementById('nuevoEstadoEquipoVinculadoSelect').required = true;
                }
            } else {
                showMessageBox(response.message, 'error');
                equipoEncontradoContent.style.display = 'none';
            }
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateForm()) { return; }
            setFormEnabled(modificacionForm, false, submitLoading);
            
            const formData = {
                telefono: document.getElementById('telefono').value,
                tipo: tipoSelect.value,
                responsable: responsableSelect.value,
                idsucursal: sucursalSelect.value,
                extension: extensionInput.value,
                notas: notasTextarea.value,
                vincularEquipo: {
                    id: document.getElementById('nuevoEquipoId').value || null,
                    imei: document.getElementById('nuevoEquipoImei').value || null,
                    fechaReasignacion: nuevaFechaReasignacionInput.value,
                    observaciones: nuevasObservacionesTextarea.value
                },
                estadoEquipoAnterior: nuevoEstadoEquipoVinculadoSelect.value || null
            };
            
            google.script.run.withSuccessHandler(onUpdateSuccess).withFailureHandler(onUpdateFailure).procesarModificacionLineaFormulario(formData);
        }

        function onUpdateSuccess(response) {
            if(response.success){
                showMessageBox(response.message, 'success');
                resetAllForms();
            } else { onUpdateFailure({message: response.message}); }
        }
        
        function onUpdateFailure(error) {
            setFormEnabled(modificacionForm, true, submitLoading);
            showMessageBox('Error al guardar: ' + error.message, 'error');
        }

        function validateForm() {
            let isValid = true;
            [tipoSelect, responsableSelect, sucursalSelect].forEach(field => {
                if (!field.value) { field.style.borderColor = 'red'; isValid = false; } 
                else { field.style.borderColor = '#e2e8f0'; }
            });
            
            if (equipoEncontradoContent.style.display !== 'none' && !nuevaFechaReasignacionInput.value) {
                 nuevaFechaReasignacionInput.style.borderColor = 'red';
                 isValid = false;
            } else {
                 nuevaFechaReasignacionInput.style.borderColor = '#e2e8f0';
            }
            
            if (nuevoEstadoEquipoVinculadoContainer.style.display !== 'none' && !nuevoEstadoEquipoVinculadoSelect.value) {
                nuevoEstadoEquipoVinculadoSelect.style.borderColor = 'red';
                isValid = false;
            } else {
                nuevoEstadoEquipoVinculadoSelect.style.borderColor = '#e2e8f0';
            }

            if(!isValid){
                showMessageBox('Por favor, completa todos los campos obligatorios marcados en rojo.', 'error');
            }
            return isValid;
        }
        
        function handleRedirect() {
            setFormEnabled(searchSection, false, searchLoading);
            google.script.run.withSuccessHandler(url => window.top.location.href = url).redirigirOtraApp();
        }

        function resetAllForms() {
            searchTelefonoInput.value = '';
            searchTelefonoError.style.display = 'none';
            modificacionForm.reset();
            modificacionForm.style.display = 'none';
            equipoEncontradoContent.style.display = 'none';
            searchEquipoImeiInput.value = '';
            nuevoEstadoEquipoVinculadoContainer.style.display = 'none';
            nuevoEstadoEquipoVinculadoSelect.required = false;
            setFormEnabled(searchSection, true);
            setFormEnabled(modificacionForm, false);
        }
        
        // --- Pegar aquí los cuerpos de las funciones de utilidad ---
        showMessageBox = function(message, type = 'success', duration = 4000) {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'error' ? '#ef4444' : '#10b981';
            messageBox.classList.add('show');
            setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }
        setFormEnabled = function(formEl, enabled, loadingEl) {
            const elements = formEl.querySelectorAll('input, select, textarea, button');
            elements.forEach(el => el.disabled = !enabled);
            if (loadingEl) loadingEl.style.display = enabled ? 'none' : 'block';
        }
        populateSelect = function(selectEl, data, placeholder) {
            selectEl.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = placeholder;
            selectEl.appendChild(defaultOption);
            if(data && Array.isArray(data)){
                data.forEach(optionText => {
                    if (optionText) {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        selectEl.appendChild(option);
                    }
                });
            }
        }
        
        window.onload = initForm;
    })();
    </script>
</body>
</html>