<!-- darAltaLineaEquipo.html -->
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Formulario: Dar de Alta Línea y Equipo</title>
    <?!= HtmlService.createHtmlOutputFromFile('FormStyles').getContent(); ?>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 0.25em;
            display: none;
        }
        .char-counter {
            font-size: 0.75em;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }
        .info-container {display: flex;align-items: center;gap: 8px;}
        .info-icon {display: inline-block;width: 18px;height: 18px;border-radius: 50%;background-color: #6c757d;color: white;text-align: center;font-size: 12px;font-weight: bold;line-height: 18px;cursor: pointer;position: relative;        }
        .info-icon .tooltiptext {visibility: hidden;width: 220px;background-color: #333;color: #fff;text-align: center;border-radius: 6px;padding: 8px;position: absolute;z-index: 1;bottom: 125%;left: 50%;margin-left: -110px;opacity: 0;transition: opacity 0.3s;}
        .info-icon:hover .tooltiptext {visibility: visible;opacity: 1;}
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h2 class="section-title">Alta Línea Celular Nueva y Equipo Celular Nuevo</h2>
            <form id="altaLineaEquipoForm" class="space-y-6">
                <fieldset>
                    <legend>Datos de Línea Celular</legend>
                    <div class="form-grid">
                        <div>
                            <div class="info-container">
                                <label for="region">Región</label>
                                <span class="info-icon">i<span class="tooltiptext">La Región se Compone de 3 caracteres, la sigla de region y el numero de la región a 2 cifras, Ejemplo: R05. Se Anexa en el contrato como "REGIÓN"</span></span>
                            </div>
                            <input type="text" id="region" name="region" maxlength="3" required>
                        </div>
                        <div>
                           
                            <div class="info-container">
                                <label for="cuenta_padre">Cuenta Padre</label>
                                <span class="info-icon">i<span class="tooltiptext">La cuenta padre se compone solo de números de entre 7 y 9 digitos. Se Anexa en el contrato como "No. DE CUENTA", Cuenta y Cuenta Padre sera el mismo numero.</span></span>
                            </div>
                            <input type="text" id="cuenta_padre" name="cuenta_padre" maxlength="15" required>
                            <p id="cuenta_padreError" class="error-message">Solo números enteros.</p>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="cuenta">Cuenta</label>
                                <span class="info-icon">i<span class="tooltiptext">La cuenta se compone solo de números de entre 7 y 9 digitos. Se Anexa en el contrato como "No. DE CUENTA".</span></span>
                            </div>
                            <input type="text" id="cuenta" name="cuenta" maxlength="15" required>
                            <p id="cuentaError" class="error-message">Solo números enteros.</p>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="telefono">Teléfono</label>
                                <span class="info-icon">i<span class="tooltiptext">El campo se compone solo por 10 números sin espacios. Se Anexa en el contrato como "No. DE LÍNEA"</span></span>
                            </div>
                            <input type="tel" id="telefono" name="telefono" maxlength="10" required>
                            <p id="telefonoError" class="error-message">Teléfono inválido (10 dígitos numéricos) o ya existe.</p>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="clave_plan">Clave Plan</label>
                                <span class="info-icon">i<span class="tooltiptext">El campo se compone de letras en mayuscula y numero, se Anexa en el contrato. Ejemplo: VPN3</span></span>
                            </div>
                            <input type="text" id="clave_plan" name="clave_plan" maxlength="10" required>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="nombre_plan">Nombre Plan</label>
                                <span class="info-icon">i<span class="tooltiptext">El campo se compone de letras en mayuscula y numero, se Anexa en el contrato. Ejemplo: VPN3</span></span>
                            </div>
                            <input type="text" id="nombre_plan" name="nombre_plan" maxlength="12" required>
                        </div>
                        <div class="full-width">
                            
                            <div class="info-container">
                                <label for="minutos">Minutos</label>
                                <span class="info-icon">i<span class="tooltiptext">El campo debe llevar letras en mayuscula, se Anexa en el contrato. Ejemplo: ILIMITADOS</span></span>
                            </div>
                            <input type="text" id="minutos" name="minutos" maxlength="50" required>
                            <p id="minutosError" class="error-message">Este campo es obligatorio.</p>
                        </div>
                        <div class="full-width">
                            
                            <div class="info-container">
                                <label for="mensajes">Mensajes (SMS)</label>
                                <span class="info-icon">i<span class="tooltiptext">El campo debe llevar letras en mayuscula, se Anexa en el contrato. Ejemplo: ILIMITADOS.</span></span>
                            </div>
                            <input type="text" id="mensajes" name="mensajes" maxlength="50" required>
                            <p id="mensajesError" class="error-message">Este campo es obligatorio.</p>
                            
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="monto_renta">Monto Renta</label>
                                <span class="info-icon">i<span class="tooltiptext">El contenido es el monto con decimales del pago mensual de la renta. Se Anexa en el contrato como "CARGO EQUIPO MENSUAL". Ejemplo: 329.61</span></span>
                            </div>
                            <input type="text" id="monto_renta" name="monto_renta" placeholder="$0.00" required>
                            <p id="monto_rentaError" class="error-message">Monto de renta inválido (mayor a 0).</p>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="duracion_plan">Duración Plan (Meses)</label>
                                <span class="info-icon">i<span class="tooltiptext">Es el número de meses. Se Anexa en el contrato como "No. DE PARCIALIDADES". Ejemplo: 24</span></span>
                            </div>
                            <input type="text" id="duracion_plan" name="duracion_plan" required>
                            <p id="duracion_planError" class="error-message">Solo números enteros.</p>
                        </div>
                        <div>
                            <label for="fecha_inicio">Fecha Inicio</label>
                            <input type="date" id="fecha_inicio" name="fecha_inicio" required>
                            <p id="fecha_inicioError" class="error-message">La fecha de inicio no puede ser futura.</p>
                        </div>
                        <div>
                            <label for="fecha_termino">Fecha Término</label>
                            <input type="date" id="fecha_termino" name="fecha_termino" required>
                            <p id="fecha_terminoError" class="error-message">La fecha de término debe ser mayor a la fecha de inicio.</p>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="sim">SIM</label>
                                <span class="info-icon">i<span class="tooltiptext">Es el identificador de la línea, son 19 numeros, se Anexa en el contrato. Ejemplo: </span></span>
                            </div>
                            <input type="text" id="sim" name="sim" minlength="19" required>
                            <p id="simError" class="error-message">SIM inválido (mínimo 19 dígitos numéricos).</p>
                        </div>
                        <div>
                            <label for="tipo">Tipo de Servicio</label>
                            <select id="tipo" name="tipo" required>
                                <option value="">Cargando tipos...</option>
                            </select>
                        </div>
                        <div id="lineaSinequipoContainer" style="display: none;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="lineaSinequipo" name="lineaSinequipo">
                                <span>Alta de Línea sin Equipo</span>
                            </label>
                        </div>
                        <div>
                            <label for="idsucursal">Sucursal</label>
                            <select id="idsucursal" name="idsucursal" required>
                                <option value="">Cargando sucursales...</option>
                            </select>
                        </div>
                        <div>
                            <label for="responsable">Responsable</label>
                            <select id="responsable" name="responsable" required>
                                <option value="">Cargando responsables...</option>
                            </select>
                        </div>
                        
                        <div class="full-width">
                            
                            <div class="info-container">
                                <label for="datos">Datos (GB)</label>
                                <span class="info-icon">i<span class="tooltiptext">La cantidad de megas de navegación en GB, se Anexa en el contrato. Ejemplo: 10.5</span></span>
                            </div>
                            <input type="text" id="datos" name="datos" required>
                            <p id="datosError" class="error-message">Este campo es obligatorio.</p>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="extension">Extensión</label>
                                <span class="info-icon">i<span class="tooltiptext">Número de extension interno de Hemoeco, se encuentra en Score. Ejemplo: 2020</span></span>
                            </div>
                            <input type="text" id="extension" name="extension">
                        </div>
                        
                    </div>
                </fieldset>

                <fieldset id="equipoNuevoSection" style="display: none;">
                    <legend>Datos de Equipo Celular Nuevo</legend>
                    <div class="form-grid">
                        <div>
                            
                            <div class="info-container">
                                <label for="costo_equipo_nuevo">Costo del Equipo (MXN)</label>
                                <span class="info-icon">i<span class="tooltiptext">El costo del equipo aparece en el Anexo como "PRECIO DE CONTADO". Ejemplo: $28499.00 </span></span>
                            </div>
                            <input type="text" id="costo_equipo_nuevo" name="costo_equipo_nuevo" placeholder="$0.00" >
                            <p id="costo_equipo_nuevoError" class="error-message">El costo debe ser numérico y mayor a $0.00.</p>
                        </div>
                        <div>
                            <label for="marca_nuevo">Marca</label>
                            <select id="marca_nuevo" name="marca_nuevo" >
                                <option value="">Cargando marcas...</option>
                            </select>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="modelo_nuevo">Modelo</label>
                                <span class="info-icon">i<span class="tooltiptext">El nombre del modelo puedo variar del contrato, favor de comparar el modelo del equipo en su caja original</span></span>
                            </div>
                            <select id="modelo_nuevo" name="modelo_nuevo" >
                                <option value="">Cargando modelos...</option>
                            </select>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="ram_nuevo">RAM</label>
                                <span class="info-icon">i<span class="tooltiptext">Capacidad de procesamiento del Equipo Celular. Debe aparecer en la caja del Equipo Celular</span></span>
                            </div>
                            <select id="ram_nuevo" name="ram_nuevo" >
                                <option value="">Cargando RAM...</option>
                            </select>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="rom_nuevo">ROM (Almacenamiento)</label>
                                <span class="info-icon">i<span class="tooltiptext">Capacidad de Almacenamiento interno. Se especifica en el modelo o en la caja del equipo celular. </span></span>
                            </div>
                            <select id="rom_nuevo" name="rom_nuevo" >
                                <option value="">Cargando ROM...</option>
                            </select>
                        </div>
                        <div>
                            
                            <div class="info-container">
                                <label for="imei_equipo_nuevo">IMEI</label>
                                <span class="info-icon">i<span class="tooltiptext">Se Anexa en el contrato como "IMEI", favor de comparar el IMEI en el contrato con el IMEI que aparece en la caja del Equipo Celular</span></span>
                            </div>
                            <input type="text" id="imei_equipo_nuevo" name="imei_equipo_nuevo" minlength="15" maxlength="16">
                            <p id="imei_equipo_nuevoError" class="error-message">IMEI inválido (15 o 16 dígitos numéricos) o ya existe.</p>
                        </div>
                        <div class="full-width">
                            <label for="observaciones_equipo_nuevo">Observaciones del Equipo Nuevo</label>
                            <textarea id="observaciones_equipo_nuevo" name="observaciones_equipo_nuevo" maxlength="100"></textarea>
                            <p class="char-counter"><span id="observaciones_equipo_nuevoCharCount">0</span>/100</p>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Guardar Registro de Alta</button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">Limpiar Formulario</button>
                    <button type="button" class="btn btn-tertiary" id="redirectBtn">Volver al Menú</button>
                </div>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Cargando... Por favor, espere.</p>
                </div>
            </form>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>
    <script>
    (function() {
        // --- 1. REFERENCIAS A ELEMENTOS DEL DOM ---
        const form = document.getElementById('altaLineaEquipoForm');
        const submitBtn = document.getElementById('submitBtn');
        const clearBtn = document.getElementById('clearBtn');
        const redirectBtn = document.getElementById('redirectBtn');
        const loading = document.getElementById('loading');
        const messageBox = document.getElementById('messageBox');

        // Sección de Línea
        const tipoSelect = document.getElementById('tipo');
        const duracionPlanInput = document.getElementById('duracion_plan');
        const fechaInicioInput = document.getElementById('fecha_inicio');
        const fechaTerminoInput = document.getElementById('fecha_termino');
        const telefonoInput = document.getElementById('telefono');
        const telefonoError = document.getElementById('telefonoError');
        const sucursalSelect = document.getElementById('idsucursal');
        const responsableSelect = document.getElementById('responsable');
        
        // Contenedores y campos condicionales
        const lineaSinequipoContainer = document.getElementById('lineaSinequipoContainer');
        const lineaSinequipoCheckbox = document.getElementById('lineaSinequipo');
        const equipoNuevoSection = document.getElementById('equipoNuevoSection');

        // Campos dentro de la sección de equipo
        const costoEquipoNuevoInput = document.getElementById('costo_equipo_nuevo');
        const marcaNuevoSelect = document.getElementById('marca_nuevo');
        const modeloNuevoSelect = document.getElementById('modelo_nuevo');
        const ramNuevoSelect = document.getElementById('ram_nuevo');
        const romNuevoSelect = document.getElementById('rom_nuevo');
        const imeiEquipoNuevoInput = document.getElementById('imei_equipo_nuevo');
        const imeiEquipoNuevoError = document.getElementById('imei_equipo_nuevoError');

        const equipoFields = [costoEquipoNuevoInput, marcaNuevoSelect, modeloNuevoSelect, ramNuevoSelect, romNuevoSelect, imeiEquipoNuevoInput];
        
        // --- 2. FUNCIONES DE UTILIDAD (completas) ---
        function showMessageBox(message, type = 'success', duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = type === 'error' ? '#ef4444' : '#10b981';
            messageBox.classList.add('show');
            setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }

        function setFormEnabled(enabled) {
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) { elements[i].disabled = !enabled; }
            submitBtn.disabled = !enabled;
            clearBtn.disabled = !enabled;
            redirectBtn.disabled = !enabled;
            loading.style.display = enabled ? 'none' : 'block';
        }

        function populateSelect(selectElement, optionsData, placeholderText) {
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = placeholderText;
            selectElement.appendChild(defaultOption);
            if (optionsData && Array.isArray(optionsData)) {
                optionsData.forEach(optionText => {
                    if (optionText) {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        selectElement.appendChild(option);
                    }
                });
            }
        }

        function allowOnlyNumbers(inputEl) {
            inputEl.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); });
        }

        function formatCurrencyInput(inputElement) {
            // Evento que se dispara con cada tecla que presionas
            inputElement.addEventListener('input', function() {
                let value = this.value.replace(/[^0-9.]/g, '');
                const firstPeriodIndex = value.indexOf('.');
                if (firstPeriodIndex !== -1) {
                    let integerPart = value.substring(0, firstPeriodIndex);
                    let decimalPart = value.substring(firstPeriodIndex + 1).replace(/\./g, ''); // Quita puntos adicionales
                    value = integerPart + '.' + decimalPart;
                }
                let parts = value.split('.');
                let integerPart = parts[0];
                let decimalPart = parts[1];
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                if (decimalPart && decimalPart.length > 2) {
                    decimalPart = decimalPart.substring(0, 2);
                }
                let finalValue = '$' + integerPart;
                if (value.includes('.')) {
                    finalValue += '.' + (decimalPart || ''); // Añade el punto y la parte decimal (o nada si aún no hay)
                }
                
                this.value = finalValue;
            });
            inputElement.addEventListener('blur', function() {
                let value = this.value.replace(/[^0-9.]/g, '');
                
                // Si el valor no está vacío, lo formatea a dos decimales fijos.
                if (value) {
                    // Se asegura de que termine en .00 si no tiene decimales
                    const number = parseFloat(value);
                    this.value = '$' + number.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                } else {
                    // Si el campo se deja vacío, se limpia
                    this.value = '';
                }
            });
        }

        // --- 3. LÓGICA PRINCIPAL DEL FORMULARIO ---
        function initForm() {
            if (typeof google === 'undefined') { setTimeout(initForm, 100); return; }
            
            loadDropdowns();
            setupEventListeners();
            resetAllForms();
        }

        function setupEventListeners() {
            form.addEventListener('submit', handleFormSubmit);
            clearBtn.addEventListener('click', resetAllForms);
            redirectBtn.addEventListener('click', handleRedirect);
            
            // NUEVOS LISTENERS PARA LAS MEJORAS
            tipoSelect.addEventListener('change', applyConditionalLogic);
            lineaSinequipoCheckbox.addEventListener('change', applyConditionalLogic);
            fechaInicioInput.addEventListener('change', updateFechaTermino);
            duracionPlanInput.addEventListener('input', updateFechaTermino);

            // NUEVOS LISTENERS PARA LISTAS DEPENDIENTES
            sucursalSelect.addEventListener('change', handleSucursalChange);
            marcaNuevoSelect.addEventListener('change', handleMarcaChange);

            // Listeners existentes
            formatCurrencyInput(document.getElementById('monto_renta'));
            formatCurrencyInput(costoEquipoNuevoInput);
            allowOnlyNumbers(document.getElementById('cuenta_padre'));
            allowOnlyNumbers(document.getElementById('cuenta'));
            allowOnlyNumbers(telefonoInput);
            allowOnlyNumbers(duracionPlanInput);
            allowOnlyNumbers(document.getElementById('sim'));
            allowOnlyNumbers(imeiEquipoNuevoInput);
            allowOnlyNumbers(document.getElementById('extension'));
            document.getElementById('observaciones_equipo_nuevo').addEventListener('input', (e) => {
                document.getElementById('observaciones_equipo_nuevoCharCount').textContent = e.target.value.length;
            });
        }

        function loadDropdowns() {
            // Carga solo las listas principales. Las dependientes se cargarán al seleccionar.
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(tipoSelect, res.data, 'Selecciona un tipo'); }).getDropdownOptions('Listas2', 'F2:F');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(sucursalSelect, res.data, 'Selecciona una sucursal'); }).getDropdownOptions('Listas2', 'E2:E'); // Corregido a Listas2
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(marcaNuevoSelect, res.data, 'Selecciona una marca'); }).getDropdownOptions('Listas2', 'A2:A');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(ramNuevoSelect, res.data, 'Selecciona RAM'); }).getDropdownOptions('Listas2', 'C2:C');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(romNuevoSelect, res.data, 'Selecciona ROM'); }).getDropdownOptions('Listas2', 'D2:D');
        }
        
        // --- 4. NUEVAS FUNCIONES DE LÓGICA ---
        // MEJORA 6: Maneja el cambio de sucursal para filtrar responsables
        function handleSucursalChange() {
            const sucursalSeleccionada = sucursalSelect.value;
            responsableSelect.disabled = true;
            populateSelect(responsableSelect, [], 'Cargando responsables...');

            if (sucursalSeleccionada) {
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            populateSelect(responsableSelect, response.data, 'Selecciona un responsable');
                        }
                        responsableSelect.disabled = false;
                    })
                    .getResponsablesPorSucursal(sucursalSeleccionada);
            }
        }

        // MEJORA 5: Maneja el cambio de marca para filtrar modelos
        function handleMarcaChange() {
            const marcaSeleccionada = marcaNuevoSelect.value;
            modeloNuevoSelect.disabled = true;
            populateSelect(modeloNuevoSelect, [], 'Cargando modelos...');

            if (marcaSeleccionada) {
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.success) {
                            populateSelect(modeloNuevoSelect, response.data, 'Selecciona un modelo');
                        }
                        modeloNuevoSelect.disabled = false;
                    })
                    .getModelosPorMarca(marcaSeleccionada);
            }
        }

        // MEJORA 2: Calcula automáticamente la fecha de término
        function updateFechaTermino() {
            const fechaInicio = fechaInicioInput.value;
            const duracionMeses = parseInt(duracionPlanInput.value, 10);

            if (fechaInicio && !isNaN(duracionMeses) && duracionMeses > 0) {
                const fecha = new Date(fechaInicio + 'T00:00:00'); // Asegura que se interprete como local
                fecha.setMonth(fecha.getMonth() + duracionMeses);
                fechaTerminoInput.value = fecha.toISOString().split('T')[0];
            }
        }

        // MEJORAS 3 y 4: Muestra/oculta secciones según las selecciones
        function applyConditionalLogic() {
            const tipoServicio = tipoSelect.value;
            const sinEquipo = lineaSinequipoCheckbox.checked;

            // Lógica para el checkbox
            if (tipoServicio === 'Smartphone') {
                lineaSinequipoContainer.style.display = 'block';
            } else {
                lineaSinequipoContainer.style.display = 'none';
                lineaSinequipoCheckbox.checked = false; // Desmarcar si se cambia el tipo
            }

            // Lógica para la sección del equipo
            if (tipoServicio === 'Smartphone' && !sinEquipo) {
                equipoNuevoSection.style.display = 'block';
                equipoFields.forEach(field => field.required = true);
            } else {
                equipoNuevoSection.style.display = 'none';
                equipoFields.forEach(field => {
                    field.required = false;
                    if (field.tagName === 'SELECT') field.selectedIndex = 0;
                    else field.value = '';
                });
            }
        }

        // --- 5. FUNCIONES PRINCIPALES ACTUALIZADAS ---

        function validateForm() {
            let isValid = true;
            // Valida todos los campos que son requeridos y visibles
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                if (!field.value) {
                    isValid = false;
                    field.reportValidity();
                }
            });
            
            // Validaciones específicas de formato
            if (!/^\d{10}$/.test(telefonoInput.value)) {
                telefonoError.textContent = 'Teléfono inválido (10 dígitos numéricos) o ya existe.';
                telefonoError.style.display = 'block';
                isValid = false;
            } else {
                telefonoError.style.display = 'none';
            }

            if (equipoNuevoSection.style.display !== 'none' && !/^\d{15,16}$/.test(imeiEquipoNuevoInput.value)) {
                imeiEquipoNuevoError.textContent = 'IMEI inválido (15 o 16 dígitos numéricos) o ya existe.';
                imeiEquipoNuevoError.style.display = 'block';
                isValid = false;
            } else {
                imeiEquipoNuevoError.style.display = 'none';
            }

            return isValid;
        }

        // En el <script> de darAltaLineaEquipo.html
        function handleFormSubmit(e) {
            e.preventDefault();
            if (!validateForm()) {
                showMessageBox('Por favor, corrige los errores en el formulario.', 'error');
                return;
            }
            
            // CORRECCIÓN: Primero leemos y preparamos los datos
            const formData = new FormData(form);
            const formObject = Object.fromEntries(formData.entries());

            // Limpiamos los datos de moneda ANTES de deshabilitar el formulario
            formObject.costo_equipo_nuevo = formObject.costo_equipo_nuevo.replace(/[^0-9.]/g, '');
            formObject.monto_renta = formObject.monto_renta.replace(/[^0-9.]/g, '');

            // AHORA sí, deshabilitamos el formulario y mostramos el "cargando"
            setFormEnabled(false);

            // Finalmente, enviamos los datos ya preparados al servidor
            google.script.run
                .withSuccessHandler(response => {
                    setFormEnabled(true);
                    if (response.success) {
                        showMessageBox(response.message, 'success');
                        resetAllForms();
                    } else {
                        showMessageBox('Error: ' + response.message, 'error');
                        if (response.message.includes("IMEI")) imeiEquipoNuevoError.style.display = 'block';
                        if (response.message.includes("Teléfono")) telefonoError.style.display = 'block';
                    }
                })
                .withFailureHandler(err => {
                    setFormEnabled(true);
                    showMessageBox('Error de conexión: ' + err.message, 'error');
                })
                .procesarALyEFormulario(formObject);
        }
        
        function handleRedirect() {
            setFormEnabled(false);
            google.script.run.withSuccessHandler(url => window.top.location.href = url).redirigirOtraApp();
        }
        
        function resetAllForms() {
            form.reset();
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            applyConditionalLogic();
            
            // Deshabilitar y limpiar listas dependientes
            populateSelect(modeloNuevoSelect, [], 'Selecciona una marca primero');
            modeloNuevoSelect.disabled = true;
            populateSelect(responsableSelect, [], 'Selecciona una sucursal primero');
            responsableSelect.disabled = true;

            showMessageBox('Formulario limpiado.', 'success', 1500);
        }
        
        window.onload = initForm;
    })();
    </script>
    
</body>
</html>
