<!-- registrarEquipoUsado.html-->
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Formulario de Registro de Equipo Usado</title>
    <?!= HtmlService.createHtmlOutputFromFile('FormStyles').getContent(); ?>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo para campos deshabilitados/oscurecidos */
        .disabled-field {
            background-color: #e9ecef !important; /* Un gris más oscuro */
            color: #6c757d !important; /* Texto más oscuro */
            cursor: not-allowed;
        }
        .error-message {
            color: #dc3545; /* Rojo de error */
            font-size: 0.875em;
            margin-top: 0.25em;
            display: none; /* Oculto por defecto */
        }
        .char-counter {
            font-size: 0.75em;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h2 class="section-title">Registro de Equipo Celular Usado (Manual)</h2>
            <form id="altaEquipoUsadoForm" class="space-y-6">
                <fieldset>
                    <legend>Datos del Equipo Usado</legend>
                    <div class="form-grid">
                        <div>
                            <label for="costoEquipo">Costo del Equipo (MXN)</label>
                            <input type="text" id="costoEquipo" name="costoEquipo" placeholder="$0.00" required>
                            <p id="costoEquipoError" class="error-message">El costo debe ser mayor a $1.00.</p>
                        </div>

                        <div>
                            <label for="fechaCompra">Fecha de Compra</label>
                            <input type="date" id="fechaCompra" name="fechaCompra" required>
                            <p id="fechaCompraError" class="error-message">La fecha de compra no puede ser futura.</p>
                        </div>

                        <div>
                            <label for="fechaRecoleccion">Fecha de Recolección</label>
                            <input type="date" id="fechaRecoleccion" name="fechaRecoleccion" required>
                            <p id="fechaRecoleccionError" class="error-message">La fecha de recolección no puede ser futura.</p>
                        </div>

                        <div>
                            <label for="estado">Estado</label>
                            <select id="estado" name="estado" required>
                                <option value="">Cargando estados...</option>
                            </select>
                        </div>

                        <div class="full-width">
                            <label for="observaciones">Observaciones</label>
                            <textarea id="observaciones" name="observaciones" rows="3" maxlength="125" placeholder="Describa en qué condiciones se está recolectando el equipo..."></textarea>
                            <p class="char-counter"><span id="observacionesCharCount">0</span>/125</p>
                        </div>

                        <div>
                            <label for="marca">Marca</label>
                            <select id="marca" name="marca" required>
                                <option value="">Cargando marcas...</option>
                            </select>
                        </div>

                        <div>
                            <label for="modelo">Modelo</label>
                            <select id="modelo" name="modelo" required>
                                <option value="">Cargando modelos...</option>
                            </select>
                        </div>

                        <div>
                            <label for="ram">RAM</label>
                            <select id="ram" name="ram" required>
                                <option value="">Cargando RAM...</option>
                            </select>
                        </div>

                        <div>
                            <label for="rom">ROM (Almacenamiento)</label>
                            <select id="rom" name="rom" required>
                                <option value="">Cargando ROM...</option>
                            </select>
                        </div>

                        <div>
                            <label for="imei">IMEI</label>
                            <input type="text" id="imei" name="imei" maxlength="16" required>
                            <p id="imeiError" class="error-message">IMEI inválido (debe ser numérico, 15 o 16 dígitos) o ya existe.</p>
                        </div>
                        
                        <div>
                            <label for="numeroTelefono">Número de Teléfono</label>
                            <input type="tel" id="numeroTelefono" name="numeroTelefono" maxlength="10">
                            <p id="numeroTelefonoError" class="error-message">Número de Teléfono inválido (debe ser numérico, 10 dígitos).</p>
                        </div>

                        <div>
                            <label for="idSucursal">Sucursal</label>
                            <select id="idSucursal" name="idSucursal" required>
                                <option value="">Cargando sucursales...</option>
                            </select>
                        </div>

                        <div>
                            <label for="responsable">Responsable</label>
                            <select id="responsable" name="responsable">
                                <option value="">Cargando solicitantes...</option>
                            </select>
                            <p id="responsableError" class="error-message" style="display: none;">El campo Responsable es obligatorio para Reasignación.</p>
                        </div>

                        <div class="full-width">
                            <label for="comentarios">Comentarios (Máximo 125 caracteres)</label>
                            <textarea id="comentarios" name="comentarios" rows="3" maxlength="125"></textarea>
                            <p class="char-counter"><span id="comentariosCharCount">0</span>/125</p>
                        </div>

                        <div id="bajaFields" class="full-width" style="display: none;">
                            <hr style="margin: 20px 0; border-top: 1px solid #e2e8f0;">
                            <h3 style="font-size: 1.1rem; font-weight: 600; color: #4a5568; margin-bottom: 15px;">Detalles de Baja</h3>
                            <div>
                                <label for="nombreSolicitanteBaja">Nombre del Solicitante de Baja</label>
                                <select id="nombreSolicitanteBaja" name="nombreSolicitanteBaja">
                                    <option value="">Cargando solicitantes...</option>
                                </select>
                            </div>
                            <div class="full-width">
                                <label for="razonBaja">Razón de la Baja</label>
                                <textarea id="razonBaja" name="razonBaja" rows="3"></textarea>
                            </div>
                        </div>

                        <div id="vendidoFields" class="full-width" style="display: none;">
                            <hr style="margin: 20px 0; border-top: 1px solid #e2e8f0;">
                            <h3 style="font-size: 1.1rem; font-weight: 600; color: #4a5568; margin-bottom: 15px;">Detalles de Venta</h3>
                            <div>
                                <label for="nombreSolicitanteVenta">Nombre del Solicitante de Venta</label>
                                <select id="nombreSolicitanteVenta" name="nombreSolicitanteVenta">
                                    <option value="">Cargando solicitantes...</option>
                                </select>
                            </div>
                            <div>
                                <label for="personaVende">Persona a la que se Vende</label>
                                <select id="personaVende" name="personaVende">
                                    <option value="">Cargando responsables...</option>
                                </select>
                            </div>
                        </div>

                        <div id="reasignacionField" style="display: none;">
                            <label for="fechaReasignacion">Fecha de Reasignación</label>
                            <input type="date" id="fechaReasignacion" name="fechaReasignacion">
                            <p id="fechaReasignacionError" class="error-message">La fecha de reasignación no puede ser futura.</p>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">Registrar Equipo Usado</button>
                    <button type="button" class="btn btn-secondary" id="clearBtn">Limpiar Formulario</button>
                    <button type="button" class="btn btn-tertiary" id="redirectBtn">Volver al Menú</button>
                </div>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Cargando... Por favor, espere.</p>
                </div>
            </form>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
    function initForm() {
        if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
            console.error("google.script.run is not defined. Retrying form initialization...");
            setTimeout(initForm, 100);
            return;
        }

        const form = document.getElementById('altaEquipoUsadoForm');
        const clearBtn = document.getElementById('clearBtn');
        const redirectBtn = document.getElementById('redirectBtn');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const messageBox = document.getElementById('messageBox');
        
        const costoEquipoInput = document.getElementById('costoEquipo');
        const costoEquipoError = document.getElementById('costoEquipoError');
        const fechaCompraInput = document.getElementById('fechaCompra');
        const fechaCompraError = document.getElementById('fechaCompraError');
        const fechaRecoleccionInput = document.getElementById('fechaRecoleccion');
        const fechaRecoleccionError = document.getElementById('fechaRecoleccionError');
        const observacionesTextarea = document.getElementById('observaciones');
        const observacionesCharCount = document.getElementById('observacionesCharCount');
        const comentariosTextarea = document.getElementById('comentarios');
        const comentariosCharCount = document.getElementById('comentariosCharCount');
        const imeiInput = document.getElementById('imei');
        const imeiError = document.getElementById('imeiError');
        const numeroTelefonoInput = document.getElementById('numeroTelefono');
        const numeroTelefonoError = document.getElementById('numeroTelefonoError');

        // Dropdown elements
        const estadoSelect = document.getElementById('estado');
        const marcaSelect = document.getElementById('marca');
        const modeloSelect = document.getElementById('modelo');
        const ramSelect = document.getElementById('ram');
        const romSelect = document.getElementById('rom');
        const idSucursalSelect = document.getElementById('idSucursal');
        const responsableSelect = document.getElementById('responsable');
        const personaVendeSelect = document.getElementById('personaVende');

        // Conditional field containers
        const bajaFieldsDiv = document.getElementById('bajaFields');
        const nombreSolicitanteBajaSelect = document.getElementById('nombreSolicitanteBaja');
        const razonBajaTextarea = document.getElementById('razonBaja');
        
        const vendidoFieldsDiv = document.getElementById('vendidoFields');
        const nombreSolicitanteVentaSelect = document.getElementById('nombreSolicitanteVenta');

        const reasignacionFieldDiv = document.getElementById('reasignacionField');
        const fechaReasignacionInput = document.getElementById('fechaReasignacion');
        const fechaReasignacionError = document.getElementById('fechaReasignacionError');
        const responsableError = document.getElementById('responsableError');

        // --- Utility Functions ---
        function showMessageBox(message, type = 'success', duration = 3000) {
            messageBox.textContent = message;
            if (type === 'success') { messageBox.style.backgroundColor = '#10b981'; } 
            else if (type === 'error') { messageBox.style.backgroundColor = '#ef4444'; }
            messageBox.classList.add('show');
            setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }

        function setFormEnabled(enabled) {
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) { elements[i].disabled = !enabled; }
            submitBtn.disabled = !enabled;
            clearBtn.disabled = !enabled;
            redirectBtn.disabled = !enabled;
            loading.style.display = enabled ? 'none' : 'block';
        }

        function populateSelect(selectElement, optionsData, placeholderText) {
            selectElement.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = placeholderText;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            selectElement.appendChild(defaultOption);
            optionsData.forEach(optionText => {
                if (optionText && String(optionText).trim() !== '') {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    selectElement.appendChild(option);
                }
            });
        }

        // --- Real-time Formatting and Validation ---
        costoEquipoInput.addEventListener('input', function() {
            let value = this.value.replace(/[^0-9.]/g, '');
            const firstPeriodIndex = value.indexOf('.');
            if (firstPeriodIndex !== -1) {
                let integerPart = value.substring(0, firstPeriodIndex);
                let decimalPart = value.substring(firstPeriodIndex + 1).replace(/\./g, '');
                value = integerPart + '.' + decimalPart;
            }
            let parts = value.split('.');
            let integerPart = parts[0];
            let decimalPart = parts[1];
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (decimalPart && decimalPart.length > 2) {
                decimalPart = decimalPart.substring(0, 2);
            }
            let finalValue = '$' + integerPart;
            if (value.includes('.')) {
                finalValue += '.' + (decimalPart || '');
            }
            this.value = finalValue;
            validateCostoEquipo();
        });

        costoEquipoInput.addEventListener('blur', function() {
            // ***** LÍNEA CORREGIDA *****
            // Se eliminó el guion extra en la expresión regular.
            let value = this.value.replace(/[^0-9.]/g, '');
            
            if (value) {
                const number = parseFloat(value);
                this.value = '$' + number.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } else {
                this.value = '';
            }
            validateCostoEquipo();
        });

        observacionesTextarea.addEventListener('input', function() { observacionesCharCount.textContent = this.value.length; });
        comentariosTextarea.addEventListener('input', function() { comentariosCharCount.textContent = this.value.length; });
        imeiInput.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); validateIMEI(); });
        numeroTelefonoInput.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); validateNumeroTelefono(); });

        // --- Client-side Validation Functions ---
        function validateCostoEquipo() {
            let value = costoEquipoInput.value.replace(/[^0-9.]/g, '');
            const numValue = parseFloat(value);
            if (isNaN(numValue) || numValue < 1) {
                costoEquipoError.style.display = 'block';
                return false;
            }
            costoEquipoError.style.display = 'none';
            return true;
        }

        function validateFechaCompra() {
            const fechaCompra = new Date(fechaCompraInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (!fechaCompraInput.value || isNaN(fechaCompra.getTime()) || fechaCompra >= today) {
                fechaCompraError.style.display = 'block';
                return false;
            }
            fechaCompraError.style.display = 'none';
            return true;
        }

        function validateFechaRecoleccion() {
            const fechaRecoleccion = new Date(fechaRecoleccionInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (!fechaRecoleccionInput.value || isNaN(fechaRecoleccion.getTime()) || fechaRecoleccion > today) {
                fechaRecoleccionError.style.display = 'block';
                return false;
            }
            fechaRecoleccionError.style.display = 'none';
            return true;
        }

        function validateFechaReasignacion() {
            if (reasignacionFieldDiv.style.display === 'block') {
                const fechaReasignacion = new Date(fechaReasignacionInput.value);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (!fechaReasignacionInput.value || isNaN(fechaReasignacion.getTime()) || fechaReasignacion > today) {
                    fechaReasignacionError.style.display = 'block';
                    return false;
                }
                fechaReasignacionError.style.display = 'none';
                return true;
            }
            return true;
        }

        function validateIMEI() {
            const imei = imeiInput.value.trim();
            if (!/^\d{15,16}$/.test(imei)) {
                imeiError.textContent = 'IMEI inválido (debe ser numérico, 15 o 16 dígitos).';
                imeiError.style.display = 'block';
                return false;
            }
            imeiError.style.display = 'none';
            return true;
        }

        function validateNumeroTelefono() {
            const telefono = numeroTelefonoInput.value.trim();
            if (numeroTelefonoInput.disabled || telefono === '') {
                numeroTelefonoError.style.display = 'none';
                return true;
            }
            if (!/^\d{10}$/.test(telefono)) {
                numeroTelefonoError.style.display = 'block';
                return false;
            }
            numeroTelefonoError.style.display = 'none';
            return true;
        }
        
        function validateResponsableForReasignacion() {
            if (estadoSelect.value === 'Reasignado' && !responsableSelect.value) {
                responsableError.style.display = 'block';
                return false;
            }
            responsableError.style.display = 'none';
            return true;
        }

        function validateForm() {
            let isValid = true;
            isValid = validateCostoEquipo() && isValid;
            isValid = validateFechaCompra() && isValid;
            isValid = validateFechaRecoleccion() && isValid;
            isValid = validateIMEI() && isValid;
            isValid = validateNumeroTelefono() && isValid;
            isValid = validateFechaReasignacion() && isValid;
            isValid = validateResponsableForReasignacion() && isValid;
            
            const requiredSelects = [estadoSelect, marcaSelect, modeloSelect, ramSelect, romSelect, idSucursalSelect];
            requiredSelects.forEach(sel => { if (!sel.value) { sel.reportValidity(); isValid = false; }});

            if (estadoSelect.value === 'Baja') {
                if (!nombreSolicitanteBajaSelect.value) {
                    showMessageBox('El nombre del solicitante de baja es obligatorio.', 'error');
                    nombreSolicitanteBajaSelect.focus();
                    isValid = false;
                }
                if (!razonBajaTextarea.value.trim()) {
                    showMessageBox('La razón de la baja es obligatoria.', 'error');
                    razonBajaTextarea.focus();
                    isValid = false;
                }
            } else if (estadoSelect.value === 'Vendido') {
                if (!nombreSolicitanteVentaSelect.value) {
                    showMessageBox('El nombre del solicitante de venta es obligatorio.', 'error');
                    nombreSolicitanteVentaSelect.focus();
                    isValid = false;
                }
                if (!personaVendeSelect.value) {
                    showMessageBox('Debe seleccionar la persona a la que se vende.', 'error');
                    personaVendeSelect.focus();
                    isValid = false;
                }
            }
            return isValid;
        }

        // --- Cargar opciones de desplegables al inicio ---
        function loadAllDropdowns() {
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(estadoSelect, res.data, 'Selecciona un estado'); }).withFailureHandler(err => showMessageBox('Error al cargar estados: ' + err.message, 'error')).getDropdownOptions('Listados', 'B2:B');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(marcaSelect, res.data, 'Selecciona una marca'); }).withFailureHandler(err => showMessageBox('Error al cargar marcas: ' + err.message, 'error')).getDropdownOptions('Listados', 'A2:A');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(modeloSelect, res.data, 'Selecciona un modelo'); }).withFailureHandler(err => showMessageBox('Error al cargar modelos: ' + err.message, 'error')).getDropdownOptions('Listados', 'C2:C');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(ramSelect, res.data, 'Selecciona RAM'); }).withFailureHandler(err => showMessageBox('Error al cargar RAM: ' + err.message, 'error')).getDropdownOptions('Listados', 'D2:D');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(romSelect, res.data, 'Selecciona Almacenamiento'); }).withFailureHandler(err => showMessageBox('Error al cargar ROM: ' + err.message, 'error')).getDropdownOptions('Listados', 'E2:E');
            google.script.run.withSuccessHandler(res => { if (res.success) populateSelect(idSucursalSelect, res.data, 'Selecciona una sucursal'); }).withFailureHandler(err => showMessageBox('Error al cargar sucursales: ' + err.message, 'error')).getDropdownOptions('Listados', 'F2:F');
            
            google.script.run.withSuccessHandler(function(response) {
                if (response.success) {
                    const employeeList = response.data;
                    populateSelect(responsableSelect, employeeList, 'Selecciona un responsable');
                    populateSelect(personaVendeSelect, employeeList, 'Selecciona persona a vender');
                    populateSelect(nombreSolicitanteBajaSelect, employeeList, 'Selecciona un solicitante');
                    populateSelect(nombreSolicitanteVentaSelect, employeeList, 'Selecciona un solicitante');
                } else { showMessageBox('Error al cargar responsables: ' + response.message, 'error'); }
            }).withFailureHandler(err => showMessageBox('Error de conexión al cargar responsables: ' + err.message, 'error')).getDropdownOptions('BD', 'A2:A');
        }

        // --- Conditional Field Logic ---
        estadoSelect.addEventListener('change', function() {
            const selectedState = this.value;
            // Reset all
            bajaFieldsDiv.style.display = 'none';
            nombreSolicitanteBajaSelect.required = false;
            razonBajaTextarea.required = false;
            vendidoFieldsDiv.style.display = 'none';
            nombreSolicitanteVentaSelect.required = false;
            personaVendeSelect.required = false;
            reasignacionFieldDiv.style.display = 'none';
            fechaReasignacionInput.required = false;
            numeroTelefonoInput.disabled = false;
            numeroTelefonoInput.classList.remove('disabled-field');
            numeroTelefonoInput.placeholder = '';
            responsableSelect.disabled = false;
            responsableSelect.classList.remove('disabled-field');
            responsableSelect.required = false;
            observacionesTextarea.required = false;
            observacionesTextarea.placeholder = 'Describa en qué condiciones se está recolectando el equipo...';

            if (selectedState === 'Baja') {
                numeroTelefonoInput.disabled = true;
                numeroTelefonoInput.value = '';
                numeroTelefonoInput.classList.add('disabled-field');
                responsableSelect.disabled = true;
                responsableSelect.value = '';
                responsableSelect.classList.add('disabled-field');
                bajaFieldsDiv.style.display = 'block';
                nombreSolicitanteBajaSelect.required = true;
                razonBajaTextarea.required = true;
            } else if (selectedState === 'Stock' || selectedState === 'Robado') {
                numeroTelefonoInput.disabled = true;
                numeroTelefonoInput.value = '';
                numeroTelefonoInput.classList.add('disabled-field');
                responsableSelect.disabled = true;
                responsableSelect.value = '';
                responsableSelect.classList.add('disabled-field');
                if (selectedState === 'Robado') { comentariosTextarea.placeholder = 'Favor de agregar anotaciones del Robo'; }
                if (selectedState === 'Stock') {
                    observacionesTextarea.required = true;
                    observacionesTextarea.placeholder = 'Describa en qué condiciones se está recolectando el equipo... (OBLIGATORIO)';
                }
            } else if (selectedState === 'Vendido') {
                numeroTelefonoInput.disabled = true;
                numeroTelefonoInput.value = '';
                numeroTelefonoInput.classList.add('disabled-field');
                responsableSelect.disabled = true;
                responsableSelect.value = '';
                responsableSelect.classList.add('disabled-field');
                vendidoFieldsDiv.style.display = 'block';
                nombreSolicitanteVentaSelect.required = true;
                personaVendeSelect.required = true;
            } else if (selectedState === 'Reasignado') {
                reasignacionFieldDiv.style.display = 'block';
                fechaReasignacionInput.required = true;
                numeroTelefonoInput.required = true;
                numeroTelefonoInput.placeholder = 'Numero de Teléfono OBLIGATORIO';
                responsableSelect.required = true;
                const today = new Date();
                fechaReasignacionInput.value = today.toISOString().split('T')[0];
            }
        });

        // --- Event Listeners ---
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm()) { showMessageBox('Por favor, corrige los errores en el formulario.', 'error'); return; }
            setFormEnabled(false);
            const formData = {
                costoEquipo: parseFloat(costoEquipoInput.value.replace(/[^0-9.]/g, '')) || 0,
                fechaCompra: fechaCompraInput.value,
                fechaRecoleccion: fechaRecoleccionInput.value,
                estado: estadoSelect.value,
                observaciones: observacionesTextarea.value,
                marca: marcaSelect.value,
                modelo: modeloSelect.value,
                ram: ramSelect.value,
                rom: romSelect.value,
                imei: imeiInput.value,
                numeroTelefono: numeroTelefonoInput.value,
                idSucursal: idSucursalSelect.value,
                responsable: responsableSelect.value,
                comentarios: comentariosTextarea.value,
                nombreSolicitanteBaja: (estadoSelect.value === 'Baja') ? nombreSolicitanteBajaSelect.value : '',
                razonBaja: (estadoSelect.value === 'Baja') ? razonBajaTextarea.value : '',
                nombreSolicitanteVenta: (estadoSelect.value === 'Vendido') ? nombreSolicitanteVentaSelect.value : '',
                personaVende: (estadoSelect.value === 'Vendido') ? personaVendeSelect.value : '',
                fechaReasignacion: (estadoSelect.value === 'Reasignado') ? fechaReasignacionInput.value : ''
            };
            google.script.run.withSuccessHandler(function(response) {
                setFormEnabled(true);
                if (response.success) {
                    showMessageBox('Datos enviados correctamente: ' + response.message, 'success');
                    form.reset();
                    resetFormState();
                } else {
                    showMessageBox('Error al enviar datos: ' + response.message, 'error');
                    if (response.message.includes("IMEI")) {
                        imeiError.textContent = response.message;
                        imeiError.style.display = 'block';
                    }
                }
            }).withFailureHandler(function(error) {
                setFormEnabled(true);
                showMessageBox('Error de conexión o script: ' + error.message, 'error');
            }).procesarRECUFormulario(formData);
        });

        clearBtn.addEventListener('click', function() { form.reset(); resetFormState(); showMessageBox('Formulario limpiado.', 'success', 2000); });
        redirectBtn.addEventListener('click', function() {
            setFormEnabled(false);
            google.script.run.withSuccessHandler(url => window.top.location.href = url)
            .withFailureHandler(err => { setFormEnabled(true); showMessageBox('Error al obtener URL: ' + err.message, 'error'); })
            .redirigirOtraApp();
        });
        imeiInput.addEventListener('input', () => { imeiError.style.display = 'none'; });

        function resetFormState() {
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            observacionesCharCount.textContent = '0';
            comentariosCharCount.textContent = '0';
            bajaFieldsDiv.style.display = 'none';
            nombreSolicitanteBajaSelect.required = false;
            razonBajaTextarea.required = false;
            vendidoFieldsDiv.style.display = 'none';
            nombreSolicitanteVentaSelect.required = false;
            personaVendeSelect.required = false;
            reasignacionFieldDiv.style.display = 'none';
            fechaReasignacionInput.required = false;
            numeroTelefonoInput.disabled = false;
            numeroTelefonoInput.classList.remove('disabled-field');
            responsableSelect.disabled = false;
            responsableSelect.classList.remove('disabled-field');
            responsableSelect.required = false;
            comentariosTextarea.placeholder = '';
            
            // Re-populate all dynamic dropdowns
            loadAllDropdowns();

            fechaCompraInput.value = '';
            const today = new Date();
            fechaRecoleccionInput.value = today.toISOString().split('T')[0];
        }

        resetFormState();
    }
    window.onload = initForm;
    </script>
</body>
</html>